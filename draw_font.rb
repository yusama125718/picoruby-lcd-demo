class DrawFont
  FONT_5X7 = {
    " " => [0x00,0x00,0x00,0x00,0x00],

    "0" => [0x3E,0x51,0x49,0x45,0x3E],
    "1" => [0x00,0x42,0x7F,0x40,0x00],
    "2" => [0x42,0x61,0x51,0x49,0x46],
    "3" => [0x21,0x41,0x45,0x4B,0x31],
    "4" => [0x18,0x14,0x12,0x7F,0x10],
    "5" => [0x27,0x45,0x45,0x45,0x39],
    "6" => [0x3C,0x4A,0x49,0x49,0x30],
    "7" => [0x01,0x71,0x09,0x05,0x03],
    "8" => [0x36,0x49,0x49,0x49,0x36],
    "9" => [0x06,0x49,0x49,0x29,0x1E],

    "A" => [0x7E,0x11,0x11,0x11,0x7E],
    "B" => [0x7F,0x49,0x49,0x49,0x36],
    "C" => [0x3E,0x41,0x41,0x41,0x22],
    "D" => [0x7F,0x41,0x41,0x22,0x1C],
    "E" => [0x7F,0x49,0x49,0x49,0x41],
    "F" => [0x7F,0x09,0x09,0x09,0x01],
    "G" => [0x3E,0x41,0x49,0x49,0x7A],
    "H" => [0x7F,0x08,0x08,0x08,0x7F],
    "I" => [0x00,0x41,0x7F,0x41,0x00],
    "J" => [0x20,0x40,0x41,0x3F,0x01],
    "K" => [0x7F,0x08,0x14,0x22,0x41],
    "L" => [0x7F,0x40,0x40,0x40,0x40],
    "M" => [0x7F,0x02,0x0C,0x02,0x7F],
    "N" => [0x7F,0x04,0x08,0x10,0x7F],
    "O" => [0x3E,0x41,0x41,0x41,0x3E],
    "P" => [0x7F,0x09,0x09,0x09,0x06],
    "Q" => [0x3E,0x41,0x51,0x21,0x5E],
    "R" => [0x7F,0x09,0x19,0x29,0x46],
    "S" => [0x46,0x49,0x49,0x49,0x31],
    "T" => [0x01,0x01,0x7F,0x01,0x01],
    "U" => [0x3F,0x40,0x40,0x40,0x3F],
    "V" => [0x1F,0x20,0x40,0x20,0x1F],
    "W" => [0x7F,0x20,0x18,0x20,0x7F],
    "X" => [0x63,0x14,0x08,0x14,0x63],
    "Y" => [0x03,0x04,0x78,0x04,0x03],
    "Z" => [0x61,0x51,0x49,0x45,0x43],
  }

  CHAR_WIDTH  = 6   # 5ドット + 右側1ピクセル空き
  CHAR_HEIGHT = 8   # 7ドット + 下1ピクセル空き
  WIDTH  = 240
  HEIGHT = 240

  def draw_char(spi, dc, x, y, ch, color, font_size=1, bg_color=nil)
    glyph = FONT_5X7[ch] || FONT_5X7[" "]  # 未定義文字は空白扱い

    0.upto(4) do |col|
      col_bits = glyph[col]
      0.upto(6) do |row|
        bit_on = (col_bits & (1 << row)) != 0
        offseted_x = x + (col * font_size)
        offseted_y = y + (row * font_size)
        if bit_on
          fast_fill_rect(spi, dc, offseted_x, offseted_y, offseted_x + font_size, offseted_y + font_size, color)
        elsif bg_color
          fast_fill_rect(spi, dc, offseted_x, offseted_y, offseted_x + font_size, offseted_y + font_size, bg_color)
        end
      end
    end

    # 右端の1列・下1列は背景を塗りたい場合だけ処理（省略可）
    if bg_color
      # 右の1列
      0.upto(6) do |row|
        draw_pixel(spi, dc, x + 5, y + row, bg_color)
      end
      # 下の1列
      0.upto(5) do |col|
        draw_pixel(spi, dc, x + col, y + 7, bg_color)
      end
    end
  end

  def draw_text(spi, dc, x, y, text, color, font_size=1, bg_color=nil)
    cx = x
    cy = y

    text.each_char do |ch|
      if ch == "\n"
        cx  = x
        cy += (CHAR_HEIGHT * font_size)
        next
      end

      draw_char(spi, dc, cx, cy, ch, color, font_size, bg_color)
      cx += (CHAR_WIDTH * font_size)

      # 画面右端を超えそうなら自動改行
      if cx + (CHAR_WIDTH * font_size) > (WIDTH * font_size)
        cx  = x
        cy += (CHAR_HEIGHT * font_size)
      end
    end
  end

  def draw_pixel(spi, dc, x, y, color)
    return if x < 0 || x >= WIDTH || y < 0 || y >= HEIGHT

    set_window(spi, dc, x, y, x, y)

    hi = (color >> 8) & 0xFF
    lo = color & 0xFF

    lcd_cmd(spi, dc, 0x2C)  # RAMWR

    dc.write 1
    spi.select
    spi.write(hi, lo)
    spi.deselect
  end
end